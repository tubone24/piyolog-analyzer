# 🍼 ぴよログ予測GAS セットアップガイド

## 📝 概要

このシステムは、ぴよログアプリのメールエクスポート機能と連携し、AI（Claude）を使って育児データを分析・予測してSlackに通知するGoogle Apps Script（GAS）です。

## ✨ 主な機能

- 📧 **Gmailからぴよログデータを自動取得**
- 🤖 **Claude AIによる高精度な予測とアドバイス**
- 📊 **Googleスプレッドシートでのデータ管理・グラフ化**
- 📱 **Slackへのリアルタイム通知**
- ⚠️ **健康状態のアラート機能**
- 🔒 **セキュアな環境変数管理**

## 🚀 5分でセットアップ

### ステップ1: プロジェクト作成

1. [Google Apps Script](https://script.google.com) を開く
2. 「新しいプロジェクト」をクリック
3. プロジェクト名を「ぴよログ予測システム」に変更

### ステップ2: コードの設置

1. 提供された以下のファイルをGASプロジェクトにコピー：
   - `piyolog-gas.ts` → `コード.gs`
   - `piyolog-gas-utils.ts` → `utils.gs`
2. 保存（Ctrl+S または Cmd+S）

### ステップ3: 初期設定の実行

GASエディタで以下を実行：

```javascript
setupEnvironment()
```

実行方法：
1. 関数選択ボックスから `setupEnvironment` を選択
2. 「実行」ボタンをクリック
3. 初回実行時は権限の承認が必要

### ステップ4: 必要なサービスの準備

#### 🔑 必須サービス

| サービス | 用途 | 料金 | 取得方法 |
|---------|------|------|---------|
| **Slack Webhook** | 通知送信 | 無料 | [設定手順](#slack-webhook-urlの取得) |
| **Anthropic API** | AI予測 | 月額$1-3 | [設定手順](#claude-api-keyの取得) |
| **Googleスプレッドシート** | データ保存 | 無料 | [設定手順](#スプレッドシートの準備) |

### ステップ5: 設定画面での入力

表示された設定画面で必要情報を入力し、テストを実行して保存完了！

## 🔐 各サービスの設定方法

### Slack Webhook URLの取得

1. [Slack API](https://api.slack.com/apps) にアクセス
2. 「Create New App」→「From scratch」を選択
3. App Name: `ぴよログBot`、Workspace: 対象のワークスペースを選択
4. 左メニュー「Incoming Webhooks」→ ONに切り替え
5. 「Add New Webhook to Workspace」をクリック
6. 投稿先チャンネルを選択（例: `#育児`, `#baby-log`）
7. 生成されたWebhook URLをコピー

**例:** `https://hooks.slack.com/services/T00000000/B00000000/XXXXXXXXXXXXXXXXXXXX`

### Claude API Keyの取得

1. [Anthropic Console](https://console.anthropic.com) にアクセス
2. アカウント作成（Gmail等でサインアップ）
3. 左メニュー「API Keys」をクリック
4. 「Create Key」をクリック
5. キー名を入力（例: `PiyologBot`）
6. **生成されたキーを必ずコピー**（再表示不可）

**料金目安:**
- Claude Sonnet 4: 1日2回実行で**月額$1-2**（約150-300円）
- Claude 3.5 Sonnet: 1日2回実行で**月額$0.5-1**（約75-150円）

### スプレッドシートの準備

1. [Google Drive](https://drive.google.com) で新規スプレッドシートを作成
2. 名前を「ぴよログデータ」に設定
3. URLから以下の部分をコピー：

```
https://docs.google.com/spreadsheets/d/【ここがID】/edit
                                    ↑
                           この部分をコピー
```

**例:** `1a2b3c4d5e6f7g8h9i0j`

## 📧 ぴよログアプリの設定

### メールエクスポートの設定

1. ぴよログアプリでメニューを開く
2. 「記録の出力」→「データのエクスポート」
3. 期間を選択：
   - 日次実行の場合: **1日**
   - 週次実行の場合: **7日**
4. **Gmailアドレス**に送信

### Gmailフィルタの設定（推奨）

自動整理のためにGmailフィルタを設定：

1. Gmail「設定」→「フィルタとブロック中のアドレス」
2. 「新しいフィルタを作成」
3. 条件設定：
   - **From**: ぴよログのメールアドレス
   - **件名**: `【ぴよログ】`
4. 処理設定：
   - ✅ ラベルを付ける: 「ぴよログ」（新規作成）
   - ✅ 受信トレイをスキップ（任意）

## ⚡ 運用開始

### 自動実行の設定

設定完了後、自動実行を有効化：

```javascript
// 朝7時と夜7時に実行
updateTriggers([7, 19])

// 朝・昼・夜の3回実行
updateTriggers([7, 12, 19])
```

### 手動実行でのテスト

```javascript
// 実際のデータで実行テスト
main()

// サンプルデータでテスト
testSystemWithSampleData()
```

## 📊 機能詳細

### AI予測機能

Claude AIが以下を分析・予測：

- 🕐 **次回授乳時刻の予測**
- 🍼 **適切なミルク量の推奨**
- 😴 **睡眠パターンの分析**
- 📈 **成長トレンドの洞察**
- 💡 **育児アドバイスの提供**

### アラート機能

設定した閾値に基づく自動アラート：

- ⚠️ ミルク摂取量の異常（多すぎ/少なすぎ）
- ⚠️ 睡眠時間の不足
- 🔴 体温の異常（発熱等）
- ⚠️ おしっこ・うんちの回数異常

### データ保存・可視化

- 📈 **自動グラフ生成**（ミルク量推移、睡眠パターン等）
- 📋 **詳細データログ**（日時、量、回数等）
- 📊 **実行ログ**（処理状況、エラー記録）

## 🛡️ セキュリティ

### 推奨設定

- ✅ 環境変数での機密情報管理
- ✅ GASプロジェクトのプライベート設定
- ✅ スプレッドシートのアクセス制限
- ✅ APIキーの定期更新（3ヶ月毎）

### 注意事項

- ❌ APIキーをコード内に直接記載しない
- ❌ プロジェクトを公開設定にしない
- ❌ APIキーを他人と共有しない

## 🔧 トラブルシューティング

### よくある問題

| 問題 | 原因 | 解決方法 |
|------|------|---------|
| Slack通知が届かない | Webhook URL無効 | URL再確認、テスト実行 |
| Claude APIエラー | キー無効/クレジット不足 | [Console](https://console.anthropic.com)で確認 |
| メールが見つからない | 検索クエリ不適切 | クエリの調整 |
| 権限エラー | 必要権限が未承認 | GAS実行時に承認 |

### デバッグモード

設定画面で「デバッグモード」をONにすると詳細ログが出力されます：

```javascript
// ログの確認
// GASエディタ → 表示 → ログ
console.log('デバッグ情報をここで確認');
```

### エラー通知

システムエラーは自動でSlackに通知されます。エラー内容を確認して適切に対処してください。

## 📈 使用状況の確認

### 実行ログ

スプレッドシートの「実行ログ」シートで確認可能：
- 実行日時
- 処理データ数
- 検出されたアラート数
- 実行時間
- ステータス（成功/エラー）

### Claude API使用量

[Anthropic Console](https://console.anthropic.com) で確認：
- 使用トークン数
- 残りクレジット
- 月次請求額

## 🎯 カスタマイズ

### アラート閾値の調整

設定画面の「詳細設定」タブで調整可能：

```javascript
// 例: 閾値をコードで設定
{
  minMilkPerDay: 600,     // 最小ミルク量/日
  maxMilkPerDay: 1000,    // 最大ミルク量/日
  minSleepHours: 12,      // 最小睡眠時間/日
  maxTemperature: 37.5    // 体温警告値
}
```

### 実行時刻の変更

```javascript
// 例: 6時・12時・18時の3回実行
updateTriggers([6, 12, 18])
```

### 通知内容のカスタマイズ

`piyolog-gas-utils.ts` の `createSlackMessage` 関数を編集して通知内容を変更可能。

## 🆘 サポート

### 設定関連の確認

```javascript
// 現在の設定を確認
loadCurrentSettings()

// 環境変数の検証
EnvironmentConfig.getInstance().validateRequired()
```

### システムの完全リセット

```javascript
// 全設定をクリア（注意：復元不可）
clearEnvironmentSettings()
```

### 問題解決の手順

1. **エラーメッセージを記録**
2. **デバッグモードでログを確認**
3. **各サービスの接続テストを実行**
4. **設定値を再確認**

## 🎉 運用成功のポイント

### 定期メンテナンス

- 📅 **月1回**: スプレッドシートのデータ確認
- 📅 **3ヶ月毎**: APIキーの更新
- 📅 **必要時**: アラート閾値の調整

### データ活用

- 📊 **トレンド分析**: 成長パターンの把握
- 🔍 **異常検知**: 早期の健康状態変化発見
- 📝 **記録保持**: 医師への相談時のデータ提供

---

**🍼 Happy Parenting with AI! 👶✨**

*このシステムが育児をより安心で楽しいものにしてくれることを願っています。*